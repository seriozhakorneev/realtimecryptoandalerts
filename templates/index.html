<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Update</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style/css/bootstrap.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='style/css/custom.min.css') }}">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
</head>

<body onload="update_values();">

  <div class="container">
    <div class="tab-pane active" id="home">
      <div class="container bootstrap snippets bootdey">

        <div class="row">
          {% if session_pairs_list %}
          {% for pair in session_pairs_list %}
          <div class="col-md-3 col-xs-6">
            <br>
            <div class="alert alert-dismissible alert-light">
              <form action="{{ url_for('delete_pair') }}" method="POST">
                <input type="hidden" name="trade_pair" value="{{ pair }}">
                <button style="font-size: 29px" type="submit" class="close text-dark">&times;</button>
              </form>
              <h5 style="color: #060606;" class="alert-heading text-warning"><strong>{{ pair }}</strong></h5>
              <p style="font-size: 20px;" id="price{{ loop.index - 1 }}">x</p>
            </div>
          </div>
          {% endfor %}
          {% endif %}
        </div>

      </div>
    </div>

    
    <footer id="footer">
      <div class="row">
        <div class="col-lg-12">
            <div class="col-md-3 col-xs-6">
              <form name="AddForm" method="POST" action="{{ url_for('add_pair') }}" onsubmit="return validateForm()">
                <div class="input-group mb-3">
                  <input type="text" list="trade_pairs" class="form-control" name="trade_pair" id='txt' placeholder="Type Pair">
                  <input type="submit" value="add pair" class="btn btn-secondary">
                </div>
              </form>
            </div>
          <p>Made by <a href="https://thomaspark.co/">Thomas Park</a>.</p>
          <p>Code released under the <a href="https://github.com/thomaspark/bootswatch/blob/master/LICENSE">MIT License</a>.</p>
          <p>Based on <a href="https://getbootstrap.com/" rel="nofollow">Bootstrap</a>. Icons from <a href="https://fontawesome.com/" rel="nofollow">Font Awesome</a>. Web fonts from <a href="https://fonts.google.com/" rel="nofollow">Google</a>.</p>
        </div>
      </div>
    </footer>

  </div>

<script type="text/javascript">
  var $SCRIPT_ROOT = window.location;
</script>

<script type="text/javascript">
  var intervalID = setInterval(update_values,1000);

  Notification.requestPermission(function(permission){
    // переменная permission содержит результат запроса
    console.log('Результат запроса прав:', permission);
    });
  
    function update_values() {
          $.getJSON($SCRIPT_ROOT + 'data',
                  
        function(data) {
          {% if session_pairs_list %}
            {% for pair in session_pairs_list %}
              $('#price{{ loop.index - 1 }}').text(data.result[{{ loop.index - 1 }}]);
            {% endfor %}
          {% endif %}

          // notification if alert
          if(data.raise_alert[0] != null)
          var notification = new Notification(data.raise_alert[0] + '  Reached ' + data.raise_alert[1]);
          else
          var notification = 123;
    
          function clickFunc() { alert(data.raise_alert[0] + '  REACHED ' + data.raise_alert[1]); }
          notification.onclick = clickFunc;

          console.log(data)
        });
      };
      function stopTextColor() {
        clearInterval(intervalID);
      }
  </script>

  <script>
    {% if session_pairs_list %}
      {% for pair in session_pairs_list %}
        document.getElementById("price{{ loop.index - 1 }}").innerHTML;
      {% endfor %}
    {% endif %}
  </script>

  <script>
    function validateForm() {
    var val = $("#txt").val();
    var obj = $("#trade_pairs").find("option[value='" + val + "']");
    
    if(obj != null && obj.length > 0)
    return true;  // allow form submission
      
    else
      alert("Invalid name,сhoose a trade pair from suggest list."); // don't allow form submission
      return false;
    }
  </script>

  <script src="{{ url_for('static', path='style/js/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', path='style/js/bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', path='style/js/custom.js') }}"></script>

  <datalist id="trade_pairs">
    {% for p_name in p_names %}
    <option value="{{ p_name }}">
    {% endfor %}
  </datalist>

</body>
</html>